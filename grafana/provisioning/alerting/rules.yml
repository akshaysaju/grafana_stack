apiVersion: 1

# Remove the old test alert group
deleteRules:
  - orgId: 1
    uid: grafana_test_alert

groups:
  - orgId: 1
    name: recommendations_alerts
    folder: Alerts
    interval: 30s
    rules:
      # Fires when 95th percentile recommendation latency exceeds 500ms
      - uid: high_recommendation_latency
        title: High Recommendation Latency
        condition: B
        data:
          # Query: P95 recommendation latency over last 2 minutes
          - refId: A
            relativeTimeRange:
              from: 120
              to: 0
            datasourceUid: prometheus
            model:
              expr: |
                histogram_quantile(0.95,
                  rate(recommendation_latency_seconds_bucket[2m])
                ) * 1000
              refId: A
              instant: true
          # Threshold: alert if value > 500 (ms)
          - refId: B
            relativeTimeRange:
              from: 0
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params:
                      - 500
                    type: gt
                  operator:
                    type: and
                  query:
                    params:
                      - A
                  reducer:
                    type: last
                  type: query
              expression: A
              refId: B
              type: threshold
        noDataState: OK
        execErrState: OK
        for: 30s
        labels:
          severity: warning
          service: recommendations-service
          source: grafana
        annotations:
          summary: "Recommendation latency is high"
          description: "P95 recommendation latency is above 500ms"
        isPaused: false
